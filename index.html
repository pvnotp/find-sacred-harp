<!DOCTYPE html>
<html> <head>
<title>Find Sacred Harp Singings</title>
<meta name=viewport content="width=600">
<link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body>

<div id="wrap">
<div id="content">
<div id="content-inner">

<div id="title">
Find Sacred Harp Singings
</div>


<!-- Search Options -->
<div id="menu">
Enter your zipcode: <input id="input" type="text" class="input"></input><br>
<form name="menu">
	Find events within: <input type="text" name="miles" value="50" class="input"> miles<br>
	Occuring within: <input type="text" name="months" value="6" class="input"> months<br>
	(<input type="checkbox" id="past" size="5" class="input">Show past singings)<br>
</form>
</div>
<button id="button">Find Singings</button>

<!-- Warnings appear under search options if events are not found -->
<div id="notfound">
Sorry, I don't recognize that zip code.
</div>

<div id="nosingings">
Sorry, no singings meet those criteria.
</div>

<!-- Singings appear here, as generated by script below -->
<div id="singings">
</div>


<!-- About page / Map -->
<div id="footer">
<center><a href="about.html">About</a></center>
</div>

</div>
</div>
</div>





<script>
var zi = document.getElementById("input");
var zb = document.getElementById("button");
var buttontext = document.getElementById("buttontext");
var singings = document.getElementById("singings");
var content = document.getElementById("content");
var notfound = document.getElementById("notfound");
var nosingings = document.getElementById("nosingings");


if (navigator.userAgent.toLowerCase().indexOf("android") > -1) {
  zi.type = "number";
}

function submit() {
  zi.value = zi.value.replace(/^\s+|\s+$/g,'');
  load_singings(zi.value);
}

zi.onkeypress = function(e) {
  if (e && e.keyCode == 13) {
    submit();
  }
}
zb.disabled = true;
zb.onclick = function(e) { submit(); };
function maybe_ready() {
  if (!!zips && !!singing_locations) {
    zb.disabled = false;
  }
}
var zips = null;
var singing_locations = null;
document.body.onload = function() {
  zi.focus();
  fetch("zipcode.json", function(response) {
    zips = JSON.parse(response);
    maybe_ready();
  });
  fetch("annualSingings_locs.json", function(response) {
    singing_locations = JSON.parse(response);
    maybe_ready();
  });
};
function fetch(url, callback) {
  var xhr = new XMLHttpRequest();
  xhr.onreadystatechange = function() {
    if (xhr.readyState==4) {
      callback(xhr.responseText);
	}
  };
  xhr.open("GET",url,true);
  xhr.send();
}
function clear_singings() {
  singings.innerHTML = "";
  menu.innerHTML = "";
}
function add_singing(title, location, date, link, books) {
  var div = document.createElement("div");
  div.className = "singing";
  if(link.length == 0){
	link = "http://www.google.com/search?q=sacred+harp+" + title;
  }
  div.innerHTML = '<div class="singing-internal"><a target="_blank" href="' + link + '">'
                  + title + '</a><br>'+ date + '</a><br>' + location + '<br>'
				  + books +'</div>';
  singings.appendChild(div);
}
function distance(lat1, lon1, lat2, lon2) {
  var R = 3959; // Radius of the earth in km
  var dLat = (lat2 - lat1) * Math.PI / 180;  // deg2rad below
  var dLon = (lon2 - lon1) * Math.PI / 180;
  var a = 
     0.5 - Math.cos(dLat)/2 + 
     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
     (1 - Math.cos(dLon))/2;

  return R * 2 * Math.asin(Math.sqrt(a));
}

function load_singings(zip, minimum_singings) {

  if (!minimum_singings) {
    minimum_singings = 3;
  }
  if (!zips || !singing_locations) {
    // loop until external jsons are done loading, if not already
    window.setTimeout(function() {
      load_singings(zip, minimum_singings);
    }, 50);
    return;
  }

  var ll = zips[zip];
  if (!ll) {
    notfound.style.display = "block";
    return;
  }
  notfound.style.display = "none";
  nosingings.style.display = "none";
  
  clear_singings();
  

  singing_timeDist = [];
  for (var i = 0 ; i < singing_locations.length ; i++) {
	var date = new Date(singing_locations[i][4])
	var today = new Date();
    singing_timeDist.push([date.getTime()-today.getTime(), i]);
  }
  singing_timeDist.sort(function(a,b){return a[0]-b[0]});
  
  var added_singings = 0;
  var n_too_far = 0;
  var n = Math.min(minimum_singings, singing_locations.length);
  const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
  const millisecondsPerMonth = 2629743830;
  for (var j = 0 ; j < singing_locations.length ; j++) {
    var t = singing_timeDist[j][0]/millisecondsPerMonth;
    var i = singing_timeDist[j][1];
	var d = distance(singing_locations[i][2],singing_locations[i][3], ll[0], ll[1]);
	if(d < document.forms["menu"]["miles"].value 
	    && t < document.forms["menu"]["months"].value 
		&& (document.getElementById("past").checked || t>0)
	){
		var date = new Date(singing_locations[i][4]);
		var endDate = new Date(date);
		var endDateValue = endDate.getDate() + Number(singing_locations[i][5]) - 1;
		endDate.setDate(endDateValue);
		var dateString = monthNames[date.getMonth()] + " " + date.getDate();
		if(singing_locations[i][5] > 1){
			dateString = dateString.concat("-" + endDate.getDate());
		}
		dateString = dateString.concat(", " + date.getFullYear() + " (" + dayNames[date.getDay()]);
		if(singing_locations[i][5] > 1){
			dateString = dateString.concat("-" + dayNames[date.getDay()]);
		}
		dateString = dateString.concat(")");
		
		var bookString = "Book";
		if(singing_locations[i][7].length != 0){
			bookString = bookString.concat("s: ");
		}else{
			bookString = bookString.concat(": ");
		}
		bookString = bookString.concat(singing_locations[i][6]);
		if(singing_locations[i][7].length != 0){
			bookString = bookString.concat(", ");
			bookString = bookString.concat(singing_locations[i][7]);
		}	
		if(singing_locations[i][8].length != 0){
			bookString = bookString.concat(", ");
			bookString = bookString.concat(singing_locations[i][8]);
		}
				
		add_singing(singing_locations[i][0],
			singing_locations[i][1],
			dateString,
			singing_locations[i][9],
			bookString);
		added_singings += 1;
	}
    
  }
  if (added_singings == 0) {
    nosingings.style.display = "block";
  } 
}
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-45031405-1', 'trycontra.com');
ga('send', 'pageview');
</script>

</body> </html>